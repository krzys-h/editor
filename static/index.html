<script src="socket.io/socket.io.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.1.3/ace.js"></script>
<style>
	#editor {
		position: absolute;
		top: 0;
		bottom: 0;
		left: 0;
		right: 0;
	}
</style>
<div id="editor"></div>
<script>
var version;
var content;
var loaded = false;
var Range = ace.require('ace/range').Range;

var success_cb = function(data) {
	if(!data.success) console.error("Operation dropped", data);
	else version = data.version;
}

var translatePosition = function(pos) {
	var p = 0;
	for(var i=0; i<pos.row; i++) p += editor.getSession().getLine(i).length+1;
	p += pos.column;
	return p;
}

var translatePositionBack = function(pos) {
	var p = {row: 0, column: 0};
	for(var i=0; editor.getSession().getLine(i).length < pos; i++) {
		p.row ++;
		pos -= editor.getSession().getLine(i).length+1;
	}
	p.column = pos;
	return p;
}

var applyOperation = function(operation)
{
	loaded = false;
	console.log(operation);
	if(typeof operation.insert !== 'undefined') {
		editor.getSession().insert(translatePositionBack(operation.position), operation.insert);
	} else if(typeof operation.remove !== 'undefined') {
		var start = translatePositionBack(operation.position);
		var end = translatePositionBack(operation.position+operation.remove);
		editor.getSession().remove(new Range(start.row, start.column, end.row, end.column));
	}
	version = operation.version+1;
	loaded = true;
}

var editor = ace.edit("editor");
editor.setTheme("ace/theme/monokai");
editor.getSession().setMode("ace/mode/text");
editor.getSession().on('change', function(e) {
	if(!loaded) return;
	console.log(e.data);
	switch(e.data.action) {
		case "insertText":
			socket.emit('post', {version: version++, position: translatePosition(e.data.range.start), insert: e.data.text}, success_cb);
		break;

		case "removeText":
			socket.emit('post', {version: version++, position: translatePosition(e.data.range.start), remove: e.data.text.length}, success_cb);
		break;

		case "removeLines":
			var l = 0;
			for(var i=0; i<e.data.lines.length; i++) l += e.data.lines[i].length+1;
			socket.emit('post', {version: version++, position: translatePosition(e.data.range.start), remove: l}, success_cb);
		break;
	}
});
editor.getSession().selection.on('changeCursor', function(e) {
	socket.emit('cursor', editor.selection.getCursor());
});

var socket = io.connect();
socket.on('connect', function() {
	socket.emit('get', function(response) {
		version = response.version;
		content = response.content;
		editor.getSession().setValue(content);
		console.log("Editor started with document version "+version);
		loaded = true;
	});
});

socket.on('operation', function(operation) {
	applyOperation(operation);
});

var cursors = {};
socket.on('cursor', function(data) {
	if(typeof cursors[data.user] !== "undefined")
		editor.getSession().removeMarker(cursors[data.user]);
	cursors[data.user] = editor.getSession().addMarker(new Range(data.cursor.row, data.cursor.column, data.cursor.row, data.cursor.column+1), "ace_cursor", data.user);
});
socket.on('cursorremove', function(user) {
	editor.getSession().removeMarker(cursors[user]);
	delete cursors[user];
});
</script>
